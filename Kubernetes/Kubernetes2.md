# 쿠버네티스 개념

## 1. Desired State
> - 관리자가 바라는 환경 (얼마나 많은 웹서버가 떠 있으면 좋은지, 몇 번 포트로 서비스하기를 원하는지 등)

![desiredstate](https://subicura.com/assets/article_images/2019-05-19-kubernetes-basic-1/desired-state.png)

- 쿠버네티스는 **현재 상태**를 모니터링하면서 관리자가 설정한 **원하는 상태**를 유지하려고 내부적으로 작업을 하는 로직을 가지고 있다.
- 따라서 관리자가 서버를 배포할 때 직접적인 동작을 명령하지 않고 상태를 선언하는 방식을 사용한다.

```
<ex>
- 명령 : nginx 컨테이너를 실행해줘 그리고 80 포트로 오픈해줘
- 선언 : 80 포트를 오픈한 nginx 컨테이너를 1개 유지해줘
```

- 명령과 선언의 차이는 CLI 명령어에서도 드러난다.
```bash
$ docker run # 명령
$ kubectl create # 상태 생성 (물론 kubectl run 명령어도 있지만 잘 사용하지 않습니다)
```
- 쿠버네티스의 핵심은 상태이며 쿠버네티스를 사용하려면 어떤 상태가 있고 어떻게 상태를 선언하는지를 알아야 한다.

## 2. 오브젝트
- 쿠버네티스는 상태를 관리하기 위한 대상을 오브젝트로 정의한다.
- 기본으로 수십 가지 오브젝트를 제공하고 새로운 오브젝트를 추가하기가 매우 쉽기 때문에 확장성이 좋다.


### _<Object Spec - YAML>_

```json
apiVersion: v1
kind: Pod
metadata:
    name: example
spec:
    containers:
    - name: busybox
        image: busybox:1.25
```
- 오브젝트의 명세는 YAML파일로 정의하고 여기에 오브젝트의 종류와 원하는 상태를 입력한다.
- 명세는 생성, 조회, 삭제로 관리할 수 있기 때문에 REST API로 쉽게 노출할 수 있다.
- 접근 권한 설정도 같은 개념을 적용하여 누가 어떤 오브젝트에 어떤 요청을 할 수 있는지 정의할 수 있다.


### _1) Pod_
> - 쿠버네티스에서 배포할 수 있는 가장 작은 단위

![pod](https://subicura.com/assets/article_images/2019-05-19-kubernetes-basic-1/pod.png)

- 한 개 이상의 컨테이너와 스토리지, 네트워크 속성을 가진다.
- Pod에 속한 컨테이너는 스토리지와 네트워크를 공유하고 서로 localhost로 접근할 수 있다.
- 컨테이너를 하나만 사용하는 경우도 반드시 Pod로 감싸서 관리한다.

### _2) ReplicaSet_
> - Pod를 여러 개 (한 개 이상) 복제하여 관리하는 오브젝트

![replicaset](https://subicura.com/assets/article_images/2019-05-19-kubernetes-basic-1/replicaset.png)

- Pod를 생성하고 개수를 유지하려면 반드시 사용해야 한다.
- 복제할 개수, 개수를 체크할 라벨 선택자, 생성할 Pod의 설정값 (템플릿) 등을 가지고 있다.
- 직접적으로 사용하기 보다는 Deployment 등 다른 오브젝트에 의해 사용되는 경우가 많다.

### _3) Voume_
> - 저장소와 관련된 오브젝트

- 호스트 디렉터리를 그대로 사용할 수도 있고 EBS와 같은 스토리지를 동적으로 생성하여 사용할 수도 있다.

### _4) Service_
> - 네트워크와 관련된 오브젝트

- Pod를 외부 네트워크와 연결해주고 여러 개의 Pod를 바라보는 내부 로드 밸런서를 생성할 때 사용한다.
- 내부 DNS에 서비스 이름을 도메인으로 등록하기 때문에 서비스 디스커버리 역할도 한다.

### _<쿠버네티스 배포방식>_
- 어플리케이션을 배포하기 위해 원하는 상태(desired state)를 다양한 오브젝트에 라벨을 붙여 정의(yaml)하고 API 서버에 전달하는 방식을 사용한다.

```
<ex>
"컨테이너를 2개 배포하고 80 포트로 오픈해줘"

- 위의 작업을 실행하기 위해 아래와 같은 명령을 전달해야 한다.

“컨테이너를 Pod으로 감싸고 type=app, app=web이라는 라벨을 달아줘.
type=app, app=web이라는 라벨이 달린 Pod이 2개 있는지 체크하고 없으면 Deployment Spec에 정의된 템플릿을 참고해서 Pod을 생성해줘.
그리고 해당 라벨을 가진 Pod을 바라보는 가상의 서비스 IP를 만들고 외부의 80 포트를 방금 만든 서비스 IP랑 연결해줘.”
```


---
## _* 참고_
1. <https://subicura.com/2019/05/19/kubernetes-basic-1.html>
